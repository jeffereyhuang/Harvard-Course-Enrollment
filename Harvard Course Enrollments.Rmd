---
title: "Harvard Course Enrollment"
author: "Jeff Huang"
date: "4/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(janitor)
library(ggplot2)
library(ggthemes)
library(ggrepel)

```


```{r download, message=FALSE, echo=FALSE, warning=FALSE}


download.file("https://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_3.22.19.xlsx", "spring_19.xlsx")

spring_19 <- read_xlsx("spring_19.xlsx", skip = 3) %>% 
  clean_names()

fs:::file_delete("spring_19.xlsx")

download.file("https://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_03.06.18.xlsx","spring_18.xlsx")

spring_18 <- read_xlsx("spring_18.xlsx", skip = 3) %>% 
  clean_names()

fs:::file_delete("spring_18.xlsx")

download.file("http://registrar.fas.harvard.edu/files/fas-registrar/files/class_enrollment_summary_by_term_2017_03_07_final_0.xlsx", "spring_17.xlsx")

spring_17 <- read_xlsx("spring_17.xlsx", skip = 3) %>% 
  clean_names()

fs:::file_delete("spring_17.xlsx")

download.file("http://registrar.fas.harvard.edu/files/fas-registrar/files/course_enrollment_statistics_0.xlsx", "spring_16.xlsx")

spring_16 <- read_xlsx("spring_16.xlsx") %>% 
  clean_names() %>% 
  dplyr::rename(course_title = course, course_department = department, u_grad = hcol, total=total_enrollment)

fs:::file_delete("spring_16.xlsx")


```
```{r}
full_courses <- bind_rows(spring_17, spring_18, spring_19, .id="year") %>%
  drop_na(course_department) %>% 
  distinct(course_id, year, .keep_all = TRUE) %>% 
  mutate(ugrad_ratio = u_grad / total) %>% 
  filter(u_grad > 3) 

top_dept <- full_courses %>% 
  select(course_department, u_grad, year) %>%
  group_by(course_department, year) %>% 
  summarize(dept_totals = sum(u_grad)) %>% 
  spread(key=year, value=dept_totals) %>% 
  ungroup() %>% 
  mutate(increase = `3` - `1`) %>% 
  arrange(desc(increase)) %>% 
  slice(1:5)

course_change <- full_courses %>% 
  filter(course_department %in% top_dept$course_department) %>% 
  select(course_title, course_department, course_id, u_grad, year) %>% 
  group_by(course_id,year) %>% 
  spread(key=year, value=u_grad) %>% 
  ungroup() %>% 
  mutate(increase = `3`-`1`) %>% 
  arrange(desc(increase))

top_3 <- course_change %>% 
  slice(1:5)

course_plot <- course_change %>% 
  mutate(top = ifelse(course_id %in% top_3$course_id, TRUE, FALSE)) %>% 
  select(-`2`) %>% 
  gather("year", "enrollment", `1`:`3`) 

  
  
  
```



```{r}

ggplot(data = subset(course_plot, top == FALSE),
             mapping = aes(x = year, y = enrollment)) +
  geom_point(alpha = 0.15, color = "gray") +
  geom_point(data = subset(course_plot, top == TRUE),
             mapping = aes(x = year, y = enrollment, color = course_department)) +
  geom_text_repel(data = subset(course_plot,
                                      top == TRUE),
                           mapping = aes(x = year,
                                   y = enrollment,
                                   label = course_title), size = 2) +
  theme_set(theme_fivethirtyeight()) +
  theme(legend.title=element_blank()) +
  
  labs(
    title="Growing Enrollment of the Highest Growing Classes from the Five Highest Growing Departments",
    subtitle="Spring 2017-2019", 
    x="Year", 
    y="Enrollment"
  ) +
  scale_x_discrete(name="Semester",
                   labels=c("Spring 2017", "Spring 2019")) +
  scale_y_discrete(name="Enrollment Size")

```


